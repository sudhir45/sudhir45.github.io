---
import { AppConfig } from '@/utils/AppConfig';
import Base from '@/layouts/Base.astro';
import PostHeader from '@/components/PostHeader.astro';
import PostContent from '@/components/PostContent.astro';
import ReadingProgress from '@/components/ReadingProgress.astro';
import AuthorStrip from '@/components/AuthorStrip.astro';

import TableOfContents from '@/components/TableOfContents.astro';
import Giscus from '@/components/Giscus.astro';

const { description } = AppConfig;

const { frontmatter, headings } = Astro.props;

// Construct explicit OG Image URL
// Astro.url.pathname will be something like /posts/my-slug/ or /posts/my-slug
// We want /og/my-slug.png
const slug = (Astro.url.pathname.split('/').pop() || Astro.url.pathname.split('/').slice(-2)[0]) || '';
const cleanSlug = slug.replace(/\/$/, ""); 
// If site is set in astro.config, Astro.site provides it
const siteUrl = Astro.site ? Astro.site.toString().replace(/\/$/, "") : 'https://sudhir45.github.io';
const ogImageUrl = `${siteUrl}/og/${cleanSlug}.png`;
const postUrl = `${siteUrl}${Astro.url.pathname}`;
---

<Base head={{ title: frontmatter.title, description: frontmatter.description || description, image: ogImageUrl }}>
	<script type="application/ld+json" is:inline set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "BlogPosting",
		"headline": frontmatter.title,
		"description": frontmatter.description || description,
		"image": ogImageUrl,
		"datePublished": frontmatter.pubDate,
		"dateModified": frontmatter.pubDate,
		"author": {
			"@type": "Person",
			"name": frontmatter.author || "Sudhir"
		},
		"publisher": {
			"@type": "Person",
			"name": "Sudhir"
		},
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": postUrl
		},
		"keywords": frontmatter.tags?.join(", ") || ""
	})} />
	<ReadingProgress />
	<div class="mx-auto flex w-full max-w-7xl flex-col items-start justify-center px-4 md:flex-row md:gap-10">
		<div class="w-full max-w-[850px] flex-1">
			<PostHeader
				title={frontmatter.title}
				author={frontmatter.author}
				tags={frontmatter.tags}
				minutesRead={frontmatter.minutesRead}
				pubDate={frontmatter.pubDate}
				isPinned={frontmatter.isPinned}
				img={{ src: frontmatter.image?.src, alt: frontmatter.image?.alt }}
			/>
			<PostContent><slot /></PostContent>
			<AuthorStrip author={frontmatter.author || "Sudhir"} />
			<Giscus />
		</div>
		
		<!-- Sidebar TOC for Desktop -->
		<aside class="sticky top-24 hidden w-64 shrink-0 lg:block">
			<div class="mb-4 text-xs font-semibold uppercase tracking-wider text-zinc-500 dark:text-zinc-500">On this page</div>
			<div class="toc-scroll max-h-[calc(100vh-10rem)] overflow-y-auto">
				<TableOfContents headings={headings} />
			</div>
		</aside>
	</div>

	<script>
		document.addEventListener('astro:page-load', () => {
			// 1. Medium Zoom for Images
			const initZoom = () => {
				const isDark = document.documentElement.classList.contains('dark');
				if ((window as any).mediumZoom) {
					const zoom = (window as any).mediumZoom('img:not(.no-zoom)', {
						margin: 24,
						background: isDark ? '#09090b' : '#ffffff',
					});
					return zoom;
				} else {
					const script = document.createElement('script');
					script.src = 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js';
					script.onload = () => {
						(window as any).mediumZoom('article img:not(.no-zoom), .prose img:not(.no-zoom)', {
							margin: 24,
							background: isDark ? '#09090b' : '#ffffff',
						});
					};
					document.head.appendChild(script);
				}
			};
			initZoom();

			// 2. Code Copy Buttons
			const blocks = document.querySelectorAll('pre');
			blocks.forEach((block) => {
				if (block.querySelector('.copy-button')) return;
				
				const parent = block.parentNode as HTMLElement;
				if (!parent.classList.contains('relative')) {
					const wrapper = document.createElement('div');
					wrapper.className = 'relative group rounded-lg overflow-hidden';
					parent.insertBefore(wrapper, block);
					wrapper.appendChild(block);
				} else {
					parent.classList.add('group');
				}

				const btn = document.createElement('button');
				btn.className = 'copy-button absolute top-3 right-3 p-1.5 rounded bg-zinc-700/50 text-zinc-400 opacity-0 transition-all hover:bg-zinc-600 hover:text-white group-hover:opacity-100 focus:opacity-100';
				btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
				btn.setAttribute('aria-label', 'Copy code');
				
				block.appendChild(btn);

				btn.addEventListener('click', async () => {
					const code = block.querySelector('code');
					if (!code) return;
					await navigator.clipboard.writeText(code.innerText);
					btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-400"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
					setTimeout(() => {
						btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
					}, 2000);
				});
			});

			// 3. GitHub Callouts via Blockquotes
			const quotes = document.querySelectorAll('blockquote');
			const icons = {
				note: '<svg class="w-5 h-5 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
				tip: '<svg class="w-5 h-5 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path></svg>',
				warning: '<svg class="w-5 h-5 text-yellow-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
				caution: '<svg class="w-5 h-5 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
			};
			
			quotes.forEach((bq) => {
				const p = bq.querySelector('p');
				if (!p) return;
				const html = p.innerHTML;
				const match = html.match(/^\[!(NOTE|TIP|WARNING|CAUTION)\](?:<br>|\n|\s*)?(.*)/i);
				if (match && match[1]) {
					const type = match[1].toLowerCase() as keyof typeof icons;
					const content = html.substring((match[0] ?? '').length);
					
					const colors = {
						note: 'border-blue-500 bg-blue-50/50 dark:bg-blue-900/10 text-blue-800 dark:text-blue-200',
						tip: 'border-green-500 bg-green-50/50 dark:bg-green-900/10 text-green-800 dark:text-green-200',
						warning: 'border-yellow-500 bg-yellow-50/50 dark:bg-yellow-900/10 text-yellow-800 dark:text-yellow-200',
						caution: 'border-red-500 bg-red-50/50 dark:bg-red-900/10 text-red-800 dark:text-red-200'
					};

					bq.className = `my-6 px-4 py-3 border-l-4 rounded-r-lg ${colors[type]}`;
					bq.innerHTML = `
						<div class="flex items-center gap-2 mb-2 font-semibold capitalize tracking-wide text-sm">
							${icons[type]} ${type}
						</div>
						<div class="text-[15px] opacity-90">${match[2] ?? ''} ${content}</div>
					`;
				}
			});
		});
	</script>
</Base>
