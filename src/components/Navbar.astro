---
import Section from './Section.astro';
import Search from './Search.astro';

const normalizePath = (value: string) => {
	const trimmed = value.replace(/\/+$/, '');
	return trimmed.length > 0 ? trimmed : '/';
};

const currentPath = normalizePath(Astro.url.pathname);
const navItems = [
	{ href: '/about', label: 'About' },
	{ href: '/tags', label: 'Tags' },
	{ href: '/posts', label: 'Blog' },
	{ href: '/presentations', label: 'Presentations' }
];

const isActiveRoute = (href: string) => {
	const normalizedHref = normalizePath(href);
	return currentPath === normalizedHref || currentPath.startsWith(`${normalizedHref}/`);
};
---

<Section>
	<div id="site-header-shell" class="site-header-shell sticky top-0 z-50 -mx-4 px-4">
		<div class="site-header-inner flex items-center justify-between pb-4 pt-4">
			<div class="text-2xl font-semibold tracking-tight">
				<a href="/" class="group flex items-baseline gap-1 transition-colors hover:text-blue-600 dark:hover:text-blue-400">
					<span class="text-blue-600 dark:text-blue-400">Fort</span>
					<span class="text-zinc-700 dark:text-zinc-300">Matrix</span>
					<span class="text-zinc-400 dark:text-zinc-600 text-lg font-normal">Logs</span>
				</a>
			</div>
			<div class="flex items-center gap-6">
				<!-- Desktop Navigation -->
				<nav>
					<ul class="hidden flex-row items-center gap-6 text-sm font-medium sm:flex">
						{
							navItems.map(({ href, label }) => {
								const isActive = isActiveRoute(href);
								return (
									<li>
										<a
											href={href}
											aria-current={isActive ? 'page' : undefined}
											class={`rounded-md px-2.5 py-1.5 transition-colors ${
												isActive
													? 'bg-zinc-100 text-zinc-900 dark:bg-zinc-800/80 dark:text-zinc-100'
													: 'text-zinc-600 hover:text-blue-600 dark:text-zinc-400 dark:hover:text-blue-400'
											}`}
										>
											{label}
										</a>
									</li>
								);
							})
						}
					</ul>
				</nav>
				<!-- Desktop Theme Switcher -->
				<div class="hidden flex-col justify-center sm:flex">
					<input type="checkbox" id="light-switch-desktop" class="light-switch sr-only" />
					<label class="relative cursor-pointer rounded-lg p-2 transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-900" for="light-switch-desktop">
						<svg class="dark:hidden" width="16" height="16" xmlns="http://www.w3.org/2000/svg">
							<path
								class="fill-zinc-800"
								d="M7 0h2v2H7zM12.88 1.637l1.414 1.415-1.415 1.413-1.413-1.414zM14 7h2v2h-2zM12.95 14.433l-1.414-1.413 1.413-1.415 1.415 1.414zM7 14h2v2H7zM2.98 14.364l-1.413-1.415 1.414-1.414 1.414 1.415zM0 7h2v2H0zM3.05 1.706 4.463 3.12 3.05 4.535 1.636 3.12z"
							></path>
							<path class="fill-zinc-900" d="M8 4C5.8 4 4 5.8 4 8s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4Z"
							></path>
						</svg>
						<svg class="hidden dark:block" width="16" height="16" xmlns="http://www.w3.org/2000/svg">
							<path
								class="fill-zinc-400"
								d="M6.2 1C3.2 1.8 1 4.6 1 7.9 1 11.8 4.2 15 8.1 15c3.3 0 6-2.2 6.9-5.2C9.7 11.2 4.8 6.3 6.2 1Z"
							></path>
							<path
								class="fill-zinc-500"
								d="M12.5 5a.625.625 0 0 1-.625-.625 1.252 1.252 0 0 0-1.25-1.25.625.625 0 1 1 0-1.25 1.252 1.252 0 0 0 1.25-1.25.625.625 0 1 1 1.25 0c.001.69.56 1.249 1.25 1.25a.625.625 0 1 1 0 1.25c-.69.001-1.249.56-1.25 1.25A.625.625 0 0 1 12.5 5Z"
							></path>
						</svg>
						<span class="sr-only">Switch to light / dark version</span>
					</label>
				</div>
				
				<!-- Search Button -->
				<div class="block">
					<Search />
				</div>

				<!-- Mobile Menu Button -->
				<button 
					id="mobile-menu-button" 
					class="rounded-lg p-2 transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-900 sm:hidden" 
					aria-label="Toggle mobile menu"
					aria-expanded="false"
					aria-controls="mobile-menu"
				>
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-6 w-6"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
						stroke-width="2"
					>
						<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
					</svg>
				</button>
			</div>
		</div>
	</div>

	<!-- Mobile Menu -->
	<div
		id="mobile-menu"
		class="mt-4 hidden rounded-xl border border-zinc-200 bg-white pb-3 shadow-lg transition-all duration-200 sm:hidden dark:border-zinc-800 dark:bg-zinc-900"
	>
		<nav class="flex flex-col p-2">
			{
				navItems.map(({ href, label }) => {
					const isActive = isActiveRoute(href);
					return (
						<a
							href={href}
							data-mobile-nav-link
							aria-current={isActive ? 'page' : undefined}
							class={`rounded-lg px-4 py-2.5 text-sm font-medium transition-colors ${
								isActive
									? 'bg-zinc-100 text-zinc-900 dark:bg-zinc-800/90 dark:text-zinc-100'
									: 'text-zinc-700 hover:bg-zinc-100 hover:text-blue-600 dark:text-zinc-300 dark:hover:bg-zinc-800 dark:hover:text-blue-400'
							}`}
						>
							{label}
						</a>
					);
				})
			}
			<!-- Mobile Theme Switcher -->
			<div class="flex items-center border-t border-zinc-200 px-2 py-2 dark:border-zinc-800">
				<input type="checkbox" id="light-switch-mobile" class="light-switch sr-only" />
				<label class="relative flex w-full cursor-pointer items-center justify-between rounded-lg px-4 py-2.5 transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-800" for="light-switch-mobile">
					<span class="text-sm font-medium text-zinc-700 dark:text-zinc-300">Theme</span>
					<svg class="dark:hidden" width="16" height="16" xmlns="http://www.w3.org/2000/svg">
						<path
							class="fill-zinc-800"
							d="M7 0h2v2H7zM12.88 1.637l1.414 1.415-1.415 1.413-1.413-1.414zM14 7h2v2h-2zM12.95 14.433l-1.414-1.413 1.413-1.415 1.415 1.414zM7 14h2v2H7zM2.98 14.364l-1.413-1.415 1.414-1.414 1.414 1.415zM0 7h2v2H0zM3.05 1.706 4.463 3.12 3.05 4.535 1.636 3.12z"
						></path>
						<path class="fill-zinc-900" d="M8 4C5.8 4 4 5.8 4 8s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4Z"
						></path>
					</svg>
					<svg class="hidden dark:block" width="16" height="16" xmlns="http://www.w3.org/2000/svg">
						<path
							class="fill-zinc-400"
							d="M6.2 1C3.2 1.8 1 4.6 1 7.9 1 11.8 4.2 15 8.1 15c3.3 0 6-2.2 6.9-5.2C9.7 11.2 4.8 6.3 6.2 1Z"
						></path>
						<path
							class="fill-zinc-500"
							d="M12.5 5a.625.625 0 0 1-.625-.625 1.252 1.252 0 0 0-1.25-1.25.625.625 0 1 1 0-1.25 1.252 1.252 0 0 0 1.25-1.25.625.625 0 1 1 1.25 0c.001.69.56 1.249 1.25 1.25a.625.625 0 1 1 0 1.25c-.69.001-1.249.56-1.25 1.25A.625.625 0 0 1 12.5 5Z"
						></path>
					</svg>
					<span class="sr-only">Switch to light / dark version</span>
				</label>
			</div>
		</nav>
	</div>
</Section>

<style>
	.site-header-shell {
		transition:
			background-color 250ms ease,
			backdrop-filter 250ms ease,
			-webkit-backdrop-filter 250ms ease;
	}

	.site-header-inner {
		border-bottom: 1px solid transparent;
		transition:
			border-color 250ms ease,
			box-shadow 250ms ease;
	}

	.site-header-shell.is-scrolled {
		background: color-mix(in oklab, white 68%, transparent);
		backdrop-filter: blur(18px) saturate(140%);
		-webkit-backdrop-filter: blur(18px) saturate(140%);
	}

	:global(.dark) .site-header-shell.is-scrolled {
		background: color-mix(in oklab, #09090b 72%, transparent);
	}

	.site-header-shell.is-scrolled .site-header-inner {
		border-color: color-mix(in oklab, #d4d4d8 48%, transparent);
		box-shadow: 0 10px 20px -18px rgba(12, 10, 9, 0.45);
	}

	:global(.dark) .site-header-shell.is-scrolled .site-header-inner {
		border-color: color-mix(in oklab, #3f3f46 42%, transparent);
		box-shadow: 0 10px 20px -18px rgba(0, 0, 0, 0.75);
	}
</style>

<script>
	const NAVBAR_STATE_KEY = '__fortmatrixNavbarState';
	const NAVBAR_BOOTSTRAP_KEY = '__fortmatrixNavbarBootstrap';
	const MOBILE_OPEN_ICON = `
		<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
			<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
		</svg>
	`;
	const MOBILE_CLOSE_ICON = `
		<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
			<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
		</svg>
	`;

	function clearNavbarState() {
		const state = (window as any)[NAVBAR_STATE_KEY];
		state?.cleanup?.();
		(window as any)[NAVBAR_STATE_KEY] = null;
	}

	function setupNavbar() {
		clearNavbarState();

		const root = document.getElementById('site-header-shell');
		const lightSwitches = Array.from(document.querySelectorAll('.light-switch')) as HTMLInputElement[];
		const mobileMenuButton = document.getElementById('mobile-menu-button');
		const mobileMenu = document.getElementById('mobile-menu');
		const mobileNavLinks = Array.from(document.querySelectorAll('[data-mobile-nav-link]'));

		const applyTheme = (isDark: boolean) => {
			document.documentElement.classList.toggle('dark', isDark);
			localStorage.setItem('theme', isDark ? 'dark' : 'light');
		};

		const syncThemeSwitches = (isDark: boolean) => {
			for (const lightSwitch of lightSwitches) {
				lightSwitch.checked = isDark;
			}
		};

		const onThemeChange = (event: Event) => {
			const target = event.target as HTMLInputElement;
			const next = Boolean(target.checked);
			applyTheme(next);
			syncThemeSwitches(next);
		};

		if (lightSwitches.length > 0) {
			const storedTheme = localStorage.getItem('theme');
			const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
			const isDarkTheme = storedTheme == null ? prefersDark : storedTheme === 'dark';
			applyTheme(isDarkTheme);
			syncThemeSwitches(isDarkTheme);

			for (const lightSwitch of lightSwitches) {
				lightSwitch.addEventListener('change', onThemeChange);
			}
		}

		const setMenuState = (isOpen: boolean) => {
			if (!mobileMenuButton || !mobileMenu) return;
			mobileMenu.classList.toggle('hidden', !isOpen);
			mobileMenuButton.setAttribute('aria-expanded', String(isOpen));
			mobileMenuButton.innerHTML = isOpen ? MOBILE_CLOSE_ICON : MOBILE_OPEN_ICON;
		};

		const onMobileMenuClick = () => {
			if (!mobileMenuButton) return;
			const isOpen = mobileMenuButton.getAttribute('aria-expanded') === 'true';
			setMenuState(!isOpen);
		};

		const onMobileNavClick = () => setMenuState(false);

		if (mobileMenuButton && mobileMenu) {
			setMenuState(false);
			mobileMenuButton.addEventListener('click', onMobileMenuClick);
			for (const link of mobileNavLinks) {
				link.addEventListener('click', onMobileNavClick);
			}
		}

		const onScroll = () => {
			root?.classList.toggle('is-scrolled', window.scrollY > 8);
		};
		onScroll();
		window.addEventListener('scroll', onScroll, { passive: true });

		(window as any)[NAVBAR_STATE_KEY] = {
			cleanup: () => {
				for (const lightSwitch of lightSwitches) {
					lightSwitch.removeEventListener('change', onThemeChange);
				}
				mobileMenuButton?.removeEventListener('click', onMobileMenuClick);
				for (const link of mobileNavLinks) {
					link.removeEventListener('click', onMobileNavClick);
				}
				window.removeEventListener('scroll', onScroll);
			}
		};
	}

	if (!(window as any)[NAVBAR_BOOTSTRAP_KEY]) {
		document.addEventListener('astro:page-load', setupNavbar);
		document.addEventListener('astro:before-swap', clearNavbarState);
		(window as any)[NAVBAR_BOOTSTRAP_KEY] = true;
	}

	setupNavbar();
</script>
